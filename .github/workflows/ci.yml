name: CI

on:
  push:
    branches-ignore:
      - 'main'
      - 'docs'

env:
  BUILDER_VERSION: v0.9.21
  BUILDER_SOURCE: releases
  BUILDER_HOST: https://d19elf31gohf1l.cloudfront.net
  PACKAGE_NAME: aws-iot-device-sdk-java-v2
  RUN: ${{ github.run_id }}-${{ github.run_number }}
  AWS_DEFAULT_REGION: us-east-1
  DA_TOPIC: test/da
  DA_SHADOW_PROPERTY: datest
  DA_SHADOW_VALUE_SET: ON
  DA_SHADOW_VALUE_DEFAULT: OFF
  CI_IOT_CONTAINERS: arn:aws:iam::123124136734:role/CRT_IoT_Containers
  CI_PUBSUB_ROLE: arn:aws:iam::180635532705:role/CI_PubSub_Role
  CI_COGNITO_ROLE: arn:aws:iam::180635532705:role/CI_Cognito_Role
  CI_CUSTOM_AUTHORIZER_ROLE: arn:aws:iam::180635532705:role/CI_CustomAuthorizer_Role
  CI_SHADOW_ROLE: arn:aws:iam::180635532705:role/CI_Shadow_Role
  CI_JOBS_ROLE: arn:aws:iam::180635532705:role/CI_Jobs_Role
  CI_FLEET_PROVISIONING_ROLE: arn:aws:iam::180635532705:role/service-role/CI_FleetProvisioning_Role
  CI_GREENGRASS_ROLE: arn:aws:iam::180635532705:role/CI_Greengrass_Role
  CI_DEVICE_ADVISOR: arn:aws:iam::180635532705:role/CI_DeviceAdvisor_Role
  CI_X509_ROLE: arn:aws:iam::180635532705:role/CI_X509_Role
  CI_MQTT5_ROLE: arn:aws:iam::180635532705:role/CI_MQTT5_Role
  CI_ANDROID_DEVICE_TESTING_ROLE: arn:aws:iam::180635532705:role/CI_Android_Device_Testing_Role

jobs:
  android-device-farm:
    name: Android Device Farm
    runs-on: ubuntu-20.04 # latest
    permissions:
      # These permissions needed to interact with GitHub's OIDC Token endpoint
      id-token: write # This is required for requesting the JWT
      # contents: read
    steps:
      - name: Checkout Sources
        uses: actions/checkout@v2
        with:
            submodules: true
      # Setup JDK 11
      - name: set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: 'gradle'
      - name: Configure AWS credentials for S3 Upload
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ env.CI_ANDROID_DEVICE_TESTING_ROLE }}
          aws-region: us-west-2 # Device Farm only available in us-west-2 region
      - name: Build ${{ env.PACKAGE_NAME }}
        run: |
          cd android
          ./gradlew assembledebug
          echo "Build status report=${{ job.status }}."
      # - name: Upload apk to S3
      #   run: |
      #     cd android/app/build/outputs/apk/debug
      #     aws s3 mv app-debug.apk s3://iot-sdk-java-v2-ci-android-device-us-west-2
      - name: Python Script
        run: |
          echo "Attempting to run python script"
          python3 -m pip install boto3
          python3 ./utils/run_android_ci.py
      - name: Create Device Farm Run
      # gets a url to upload to. The file will be saved to the project Uploads as what's listed in --test
        run: |
          device_file_name="CI-${{ github.run_id }}-${{ github.run_number }}.apk"
          aws devicefarm create-upload --project-arn "arn:aws:devicefarm:us-west-2:180635532705:project:ee67d437-f890-4c6b-a2eb-8d5ed201252f" --name "$device_file_name" --type ANDROID_APP --region us-west-2 > device_file.json
          device_farm_upload_url=$(jq ".upload.url" device_file.json | cut -f2 -d\")
          echo "$device_farm_upload_url"
          device_farm_upload_arn=$(jq ".upload.arn" device_file.json | cut -f2 -d\")
          echo "$device_farm_upload_arn"
          cd android/app/build/outputs/apk/debug
          echo "Uploading $device_file_name to device farm"
          curl -T app-debug.apk "$device_farm_upload_url"
          echo "Sleeping for 10s to allow AWS to process the uploaded apk"
          sleep 10s
          echo "Scheduling run"
          aws devicefarm schedule-run --project-arn "arn:aws:devicefarm:us-west-2:180635532705:project:ee67d437-f890-4c6b-a2eb-8d5ed201252f" --app-arn "$device_farm_upload_arn" --device-pool-arn "arn:aws:devicefarm:us-west-2:180635532705:devicepool:ee67d437-f890-4c6b-a2eb-8d5ed201252f/79f3baaa-b80e-4d4d-86a8-075aadbac4d0" --name "$device_file_name" --test type=BUILTIN_FUZZ > scheduled_run.json
          device_farm_run_arn=$(jq ".run.arn" scheduled_run.json | cut -f2 -d\")
          aws devicefarm get-run --arn $device_farm_run_arn --region us-west-2  > run_results.json
          device_farm_run_status=$(jq ".run.status" run_results.json | cut -f2 -d\")
          echo "Deleting file from device farm"
          aws devicefarm delete-upload --arn "$device_farm_upload_arn"

# Need to wait for the apk to be processed by device farm. Sleep for a few before trying to schedule the run.
# aws devicefarm schedule-run --project-arn "arn:aws:devicefarm:us-west-2:180635532705:project:ee67d437-f890-4c6b-a2eb-8d5ed201252f" --app-arn "arn:aws:devicefarm:us-west-2:180635532705:upload:ee67d437-f890-4c6b-a2eb-8d5ed201252f/0a60cfd1-34db-4625-b4f2-f0bf2adee3a8" --device-pool-arn "arn:aws:devicefarm:us-west-2:180635532705:devicepool:ee67d437-f890-4c6b-a2eb-8d5ed201252f/79f3baaa-b80e-4d4d-86a8-075aadbac4d0" --name "manual_test_run" --test type=BUILTIN_FUZZ --region us-west-2