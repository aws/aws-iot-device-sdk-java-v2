name: CI

on:
  push:
    branches-ignore:
      - 'main'
      - 'docs'

env:
  BUILDER_VERSION: v0.9.21
  BUILDER_SOURCE: releases
  BUILDER_HOST: https://d19elf31gohf1l.cloudfront.net
  PACKAGE_NAME: aws-iot-device-sdk-java-v2
  RUN: ${{ github.run_id }}-${{ github.run_number }}
  AWS_DEFAULT_REGION: us-east-1
  DA_TOPIC: test/da
  DA_SHADOW_PROPERTY: datest
  DA_SHADOW_VALUE_SET: ON
  DA_SHADOW_VALUE_DEFAULT: OFF
  CI_IOT_CONTAINERS: arn:aws:iam::123124136734:role/CRT_IoT_Containers
  CI_PUBSUB_ROLE: arn:aws:iam::180635532705:role/CI_PubSub_Role
  CI_COGNITO_ROLE: arn:aws:iam::180635532705:role/CI_Cognito_Role
  CI_CUSTOM_AUTHORIZER_ROLE: arn:aws:iam::180635532705:role/CI_CustomAuthorizer_Role
  CI_SHADOW_ROLE: arn:aws:iam::180635532705:role/CI_Shadow_Role
  CI_JOBS_ROLE: arn:aws:iam::180635532705:role/CI_Jobs_Role
  CI_FLEET_PROVISIONING_ROLE: arn:aws:iam::180635532705:role/service-role/CI_FleetProvisioning_Role
  CI_GREENGRASS_ROLE: arn:aws:iam::180635532705:role/CI_Greengrass_Role
  CI_DEVICE_ADVISOR: arn:aws:iam::180635532705:role/CI_DeviceAdvisor_Role
  CI_X509_ROLE: arn:aws:iam::180635532705:role/CI_X509_Role
  CI_MQTT5_ROLE: arn:aws:iam::180635532705:role/CI_MQTT5_Role
  CI_ANDROID_DEVICE_TESTING_ROLE: arn:aws:iam::180635532705:role/CI_Android_Device_Testing_Role

jobs:
  android-device-farm:
    name: Android Device Farm
    runs-on: ubuntu-20.04 # latest
    permissions:
      # These permissions needed to interact with GitHub's OIDC Token endpoint
      id-token: write # This is required for requesting the JWT
      # contents: read
    steps:
      - name: Checkout Sources
        uses: actions/checkout@v2
        with:
            submodules: true
      # Setup JDK 11
      - name: set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: 'gradle'
      - name: Configure AWS credentials for S3 Upload
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ env.CI_ANDROID_DEVICE_TESTING_ROLE }}
          aws-region: us-west-2 # Device Farm only available in us-west-2 region
      - name: Build ${{ env.PACKAGE_NAME }}
        run: |
          cd android
          ./gradlew assembledebug
          echo "Build status report=${{ job.status }}."
      # - name: Upload apk to S3
      #   run: |
      #     cd android/app/build/outputs/apk/debug
      #     aws s3 mv app-debug.apk s3://iot-sdk-java-v2-ci-android-device-us-west-2
      - name: Create Device Farm Run
        run: |
          DEVICE_FARM_URL=$(aws devicefarm create-upload --project-arn "arn:aws:devicefarm:us-west-2:180635532705:project:ee67d437-f890-4c6b-a2eb-8d5ed201252f" --name "Test.apk" --type ANDROID_APP | jq '.url')
          echo "DEVICE_FARM_URL=$DEVICE_FARM_URL"